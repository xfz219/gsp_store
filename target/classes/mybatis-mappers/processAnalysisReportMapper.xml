<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- author:liwang  time: 2015年7月20日 上午11:17:46  comment:app全流程分析表-->
<mapper namespace="com.puhui.app.dao.ProcessAnalysisReportDao">
	<resultMap type="com.puhui.app.po.ProcessAnalysisReport" id="processAnalysisReportObj">
		<result property="saleNum" column="sale_num"/>
		<result property="salesNo" column="sales_no"/>
		<result property="salesName" column="sales_name"/>
		<result property="registCount" column="count"/>
	</resultMap>
	
	
	<!-- 通过开始时间和结束时间统计销售员的激活状态的注册用户数 -->
	<select id="queryRegisteredCount" parameterType="map" resultMap="processAnalysisReportObj">
		SELECT
			c.customer_service_manager_number AS sale_num,
			c.sales_no,
			c.sales_name,
			count(*) AS count
		FROM
			app_customer c
		WHERE
			c.is_enable = 1
			AND c.sales_no != '003578'
			<if test="startTime != null and startTime != ''">
				<![CDATA[AND c.create_time >= str_to_date(#{startTime}, '%Y-%m-%d')]]>
			</if>
			<if test="endTime != null and endTime != ''">
				<![CDATA[AND c.create_time <= str_to_date(#{endTime}, '%Y-%m-%d')]]>
			</if>
			<if test="salesNo != null and salesNo != ''">
				AND c.sales_no = #{salesNo}
			</if>
		GROUP BY
			c.customer_service_manager_number,c.sales_no,c.sales_name
	</select>
	
	<!-- 通过销售编号统计该销售下完成各种数据信息type的用户数 -->
	<select id="queryAnnexStatusTypeCount" parameterType="map" resultType="java.util.HashMap">
		SELECT
			r.customer_service_manager_number AS sale_num,
			s.type,
			count(*) AS count
		FROM
			app_lend_request r,
			app_lend_annex_status s
		WHERE
			r.id = s.app_lend_request_id
		AND (
			(
				s. STATUS != 1
				AND s.is_required = 1
			)
			OR s.is_required = 2
		)
		<if test="saleNums!=null">
			AND r.customer_service_manager_number in
			<foreach item="item" index="index" collection="saleNums" 
                         open="(" separator="," close=")">
                        #{item}
           	</foreach>
		</if>
		GROUP BY
			r.customer_service_manager_number,s.type
	</select>
	
	<!-- 通过销售编号统计该销售下完成录入所有信息项件数 -->
	<select id="queryRequestInputCompletionCount" parameterType="map" resultType="java.util.HashMap">
		SELECT
			r.customer_service_manager_number AS sale_num,
			count(*) AS count
		FROM
			app_lend_request r
		WHERE
			NOT EXISTS (
				SELECT
					*
				FROM
					app_lend_annex_status ls
				WHERE
					ls. STATUS = 1
				AND ls.is_required = 1
				AND ls.type !=15 <!--15其他证明库里存的是必填但其真实是选填顾15类型不做判断标准  -->
				AND r.id = ls.app_lend_request_id
			)
			AND EXISTS (
				SELECT
					*
				FROM
					app_lend_annex_status ls
				WHERE
					r.id = ls.app_lend_request_id
			)
			<if test="saleNums!=null">
				AND r.customer_service_manager_number in
				<foreach item="item" index="index" collection="saleNums" 
	                         open="(" separator="," close=")">
	                        #{item}
	           	</foreach>
			</if>
		GROUP BY
			r.customer_service_manager_number
	</select>
	
	<!-- 通过销售编号统计该销售下销售质检完成件数 -->
	<select id="queryRequestStateCount" parameterType="map" resultType="java.util.HashMap">
		SELECT
			r.customer_service_manager_number AS sale_num,
			count(*) AS count
		FROM
			app_lend_request r
		WHERE
			r.state != 1
			<if test="saleNums!=null">
				AND r.customer_service_manager_number in
				<foreach item="item" index="index" collection="saleNums" 
	                         open="(" separator="," close=")">
	                        #{item}
	           	</foreach>
			</if>
		GROUP BY
			r.customer_service_manager_number
	</select>
</mapper>